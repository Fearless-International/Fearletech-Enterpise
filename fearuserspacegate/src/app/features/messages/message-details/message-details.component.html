<div class="message-details-container">
  <div class="back-button-container">
    <button pButton icon="pi pi-arrow-left" label="Back to Messages" (click)="goBack()" class="p-button-text"></button>
  </div>
  
  <p-card *ngIf="!loading && message">
    <ng-template pTemplate="header">
      <div class="message-header">
        <div class="message-title">
          <h2>{{ message.subject }}</h2>
          <span *ngIf="!message.read" class="unread-badge">Unread</span>
        </div>
        <div class="message-actions">
          <button pButton icon="pi pi-trash" label="Delete" (click)="deleteMessage()" class="p-button-outlined p-button-danger"></button>
        </div>
      </div>
    </ng-template>
    
    <div class="message-content">
      <!-- Original Message -->
      <div class="message-item original-message">
        <div class="message-sender">
          <p-avatar 
            [label]="getInitials(message.sender)" 
            [style]="{'background-color': getAvatarColor(message.sender)}" 
            shape="circle"
            size="large"
          ></p-avatar>
          <div class="sender-details">
            <span class="sender-name">{{ getSenderName(message.sender) }}</span>
            <small class="sender-email" *ngIf="message.sender?.email">{{ message.sender.email }}</small>
            <small class="message-date">{{ message.createdAt | date:'medium' }}</small>
          </div>
        </div>
        <div class="message-body" [innerHTML]="message.content"></div>
      </div>
      
      <!-- Responses -->
      <div class="responses-section" *ngIf="message.responses && message.responses.length > 0">
        <h3>Responses</h3>
        
        <div class="message-item response-message" *ngFor="let response of message.responses">
          <div class="message-sender" [ngClass]="{'admin-sender': isAdmin(response.sender)}">
            <p-avatar 
              *ngIf="!isAdmin(response.sender)"
              [label]="getInitials(response.sender)" 
              [style]="{'background-color': getAvatarColor(response.sender)}" 
              shape="circle"
            ></p-avatar>
            <p-avatar 
              *ngIf="isAdmin(response.sender)"
              icon="pi pi-user" 
              styleClass="admin-avatar"
              shape="circle"
            ></p-avatar>
            <div class="sender-details">
              <span class="sender-name">{{ getSenderName(response.sender) }}</span>
              <small class="message-date">{{ response.createdAt | date:'medium' }}</small>
            </div>
          </div>
          <div class="message-body" [innerHTML]="response.content"></div>
        </div>
      </div>
      
      <!-- Response Form -->
      <div class="response-form-section">
        <h3>Send a Response</h3>
        
        <form [formGroup]="responseForm" (ngSubmit)="sendResponse()">
          <div class="p-field">
            <textarea 
              pInputTextarea 
              formControlName="content" 
              placeholder="Write your response here..." 
              [rows]="5" 
              [cols]="30"
              [ngClass]="{'ng-invalid ng-dirty': responseForm.controls['content'].invalid && responseForm.controls['content'].touched}"
            ></textarea>
            <small 
              *ngIf="responseForm.controls['content'].invalid && responseForm.controls['content'].touched" 
              class="p-error"
            >
              Response is required and must be at least 5 characters.
            </small>
          </div>
          <div class="form-actions">
            <button 
              pButton 
              type="submit" 
              icon="pi pi-send" 
              label="Send Response" 
              [disabled]="responseForm.invalid || sendingResponse"
              [loading]="sendingResponse"
            ></button>
          </div>
        </form>
      </div>
    </div>
  </p-card>
  
  <div class="loading-container" *ngIf="loading">
    <p-progressSpinner styleClass="w-4rem h-4rem" strokeWidth="8" fill="#EEEEEE" animationDuration=".5s"></p-progressSpinner>
    <p>Loading message...</p>
  </div>
  
  <div class="error-container" *ngIf="!loading && !message">
    <p-card>
      <div class="error-content">
        <i class="pi pi-exclamation-circle"></i>
        <h3>Message Not Found</h3>
        <p>The message you are looking for does not exist or has been removed.</p>
        <button pButton label="Go Back to Messages" (click)="goBack()"></button>
      </div>
    </p-card>
  </div>
</div>

<p-toast></p-toast>
<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>